<!DOCTYPE html><html lang="null"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description"/><title>SQLAlchemy | Sumarry and Promotion</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">SQLAlchemy</h1><a id="logo" href="">Sumarry and Promotion</a><p class="description">Peaceful Thinking with LGrok</p></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首頁</i></a><a href="/archives/"><i class="icon-archive"> 所有文章</i></a><a href="/about/"><i class="icon-about"> 關於</i></a><a href="/atom.xml"><i class="icon-rss"> 訂閱</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">SQLAlchemy</h1><div class="post-meta">2016-02-21 | </div><div class="post-content"><h1 id="0x01_Intraduction"><a href="#0x01_Intraduction" class="headerlink" title="0x01 Intraduction"></a>0x01 Intraduction</h1><p>SQLAlchemy is a flexible library for SQL ORM of python.It can help you  work with high-level SQL witch is constructed automatically for you,as well as automated persistence of Python objects.</p>
<h1 id="0x02_Object_relational_Mapping"><a href="#0x02_Object_relational_Mapping" class="headerlink" title="0x02 Object relational Mapping"></a>0x02 Object relational Mapping</h1><p>SQL databases behave less like object collections the more size and performance start to matter; object collections behave less like tables and rows the more abstraction starts to matter. ORM aims to accommodate both of these principles.<br>关系型数据库起源于数学建模，而面向对象编程是基于软件工程的基本原则发展起来的，两者的基础理论存在显著差异，因此伴随着对象的发展和数据库数据的增大，两者联系的矛盾愈加突出，因此对象关系映射正是为了解决这一矛盾应运而生的技术。</p>
<h1 id="0x03_QuickStart"><a href="#0x03_QuickStart" class="headerlink" title="0x03 QuickStart"></a>0x03 QuickStart</h1><ol>
<li><p>Connecting<br>To connect we use <strong>create_engine()</strong>:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="id">#connect</span> to mysql</span><br><span class="line">In [<span class="number">1</span>]: from sqlalchemy import create_engine</span><br><span class="line">In [<span class="number">2</span>]: engine = <span class="function"><span class="title">create_engine</span><span class="params">(<span class="string">'mysql://root@localhost/sqlalchemy'</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>The Engine when first returned by create_engine(), has not actually tried to connect to the database yet till the first time it is asked to perform a task against the database.</p>
</li>
<li><p>Declare a Mapping<br>We use <strong>Declarative</strong> to create classes that include directives to describe the actual database table they will be mapped to.<br>我们使用<strong>Declarative</strong>实现对数据表的描述并完成其与对象的映射关系。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">3</span>]: from sqlalchemy<span class="class">.ext</span><span class="class">.declarative</span> import declarative_base</span><br><span class="line">In [<span class="number">4</span>]: Base = <span class="function"><span class="title">declarative_base</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Create Object</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(Base)</span>:</span></span><br><span class="line"><span class="prompt">... </span>    __tablename__ = <span class="string">'users'</span></span><br><span class="line">...</span><br><span class="line"><span class="prompt">... </span>    id = Column(Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line"><span class="prompt">... </span>    name = Column(String)</span><br><span class="line"><span class="prompt">... </span>    fullname = Column(String)</span><br><span class="line"><span class="prompt">... </span>    password = Column(String)</span><br><span class="line">...</span><br><span class="line"><span class="prompt">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="prompt">... </span>       <span class="keyword">return</span> <span class="string">"&lt;User(name='%s', fullname='%s', password='%s')&gt;"</span> % (</span><br><span class="line"><span class="prompt">... </span>                            self.name, self.fullname, self.password)</span><br></pre></td></tr></table></figure>
<p>Let’s see the table attribution.</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">In</span> [<span class="number">8</span>]: User.__table__</span><br><span class="line"><span class="keyword">Out</span>[<span class="number">8</span>]: <span class="keyword">Table</span>(<span class="string">'users'</span>, MetaData(bind=<span class="keyword">None</span>), <span class="keyword">Column</span>(<span class="string">'id'</span>, <span class="keyword">Integer</span>(), table=&lt;users&gt;, primary_key=<span class="keyword">True</span>, nullable=<span class="keyword">False</span>), <span class="keyword">Column</span>(<span class="string">'name'</span>, <span class="keyword">String</span>(), table=&lt;users&gt;), <span class="keyword">Column</span>(<span class="string">'fullname'</span>, <span class="keyword">String</span>(), table=&lt;users&gt;), <span class="keyword">Column</span>(<span class="string">'password'</span>, <span class="keyword">String</span>(), table=&lt;users&gt;), schema=<span class="keyword">None</span>)</span><br></pre></td></tr></table></figure>
<p>Then create table</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">In</span> <span class="attr_selector">[9]</span>: <span class="tag">Base</span><span class="class">.metadata</span><span class="class">.create_all</span>(<span class="tag">engine</span>)</span><br><span class="line"><span class="tag">CompileError</span>                              <span class="tag">Traceback</span> (<span class="tag">most</span> <span class="tag">recent</span> <span class="tag">call</span> <span class="tag">last</span>)</span><br></pre></td></tr></table></figure>
<p>It returned error named CompileError because of Mysql should constrain the length of String.<br>Modify our code, add length after “String”.</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from sqlalchemy <span class="keyword">import</span> Column, <span class="built_in">Integer</span>, <span class="built_in">String</span></span><br><span class="line">&gt;&gt;&gt; class User(Base):</span><br><span class="line"><span class="attribute">...</span>     __tablename__ = <span class="string">'users'</span></span><br><span class="line"><span class="attribute">...</span></span><br><span class="line"><span class="attribute">...</span>     id = Column(<span class="built_in">Integer</span>, primary_key=<span class="literal">True</span>)</span><br><span class="line"><span class="attribute">...</span>     name = Column(<span class="built_in">String</span>(<span class="number">50</span>))</span><br><span class="line"><span class="attribute">...</span>     fullname = Column(<span class="built_in">String</span>(<span class="number">50</span>))</span><br><span class="line"><span class="attribute">...</span>     password = Column(<span class="built_in">String</span>(<span class="number">50</span>))</span><br><span class="line"><span class="attribute">...</span></span><br><span class="line"><span class="attribute">...</span>     def __repr__(<span class="built_in">self</span>):</span><br><span class="line"><span class="attribute">...</span>        <span class="keyword">return</span> <span class="string">"&lt;User(name='%s', fullname='%s', password='%s')&gt;"</span> % (</span><br><span class="line"><span class="attribute">...</span>                             <span class="built_in">self</span><span class="built_in">.</span>name, <span class="built_in">self</span><span class="built_in">.</span>fullname, <span class="built_in">self</span><span class="built_in">.</span>password)</span><br><span class="line"></span><br><span class="line"><span class="variable">#mysql</span></span><br><span class="line">mysql&gt; show create table users;</span><br><span class="line">+-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                                                                                                                                                |</span><br><span class="line">+-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| users | CREATE TABLE <span class="string">`users`</span> (</span><br><span class="line">  <span class="string">`id`</span> int(<span class="number">11</span>) <span class="subst">NOT</span> <span class="built_in">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="string">`name`</span> varchar(<span class="number">50</span>) DEFAULT <span class="built_in">NULL</span>,</span><br><span class="line">	  <span class="string">`fullname`</span> varchar(<span class="number">50</span>) DEFAULT <span class="built_in">NULL</span>,</span><br><span class="line">	    <span class="string">`password`</span> varchar(<span class="number">50</span>) DEFAULT <span class="built_in">NULL</span>,</span><br><span class="line">		  PRIMARY KEY (<span class="string">`id`</span>)</span><br><span class="line">		  ) ENGINE=InnoDB DEFAULT CHARSET=latin1 |</span><br><span class="line">		  +-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">		  <span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create an Instance of Mapped Class<br>With mapping complete, let’s create a User object and insert it into our database.</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; ed<span class="emphasis">_user = User(name='ed', fullname='Ed Jones', password='edspassword')</span><br><span class="line">&gt;&gt;&gt; from sqlalchemy.orm import sessionmaker</span><br><span class="line">&gt;&gt;&gt; Session = sessionmaker(bind=engine)</span><br><span class="line">&gt;&gt;&gt; session = Session()</span><br><span class="line">&gt;&gt;&gt; session.new</span><br><span class="line">	IdentitySet([&lt;User(name='ed', fullname='ED Jones', password='123456')&gt;])</span><br><span class="line">&gt;&gt;&gt; session.commit()</span><br><span class="line"></span><br><span class="line"></span>#mysql table rows</span><br><span class="line"><span class="header">mysql&gt; select * from users;</span><br><span class="line">+----+------+----------+----------+</span></span><br><span class="line"><span class="header">| id | name | fullname | password |</span><br><span class="line">+----+------+----------+----------+</span></span><br><span class="line"><span class="header">|  1 | ed   | ED Jones | 123456   |</span><br><span class="line">+----+------+----------+----------+</span></span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"># add more users</span><br><span class="line">&gt;&gt;&gt; session.add<span class="emphasis">_all([</span><br><span class="line">...     User(name='wendy', fullname='Wendy Williams', password='foobar'),</span><br><span class="line">...     User(name='mary', fullname='Mary Contrary', password='xxg527'),</span><br><span class="line">...     User(name='fred', fullname='Fred Flinstone', password='blah')])</span><br><span class="line">&gt;&gt;&gt; session.commit()</span><br><span class="line"></span><br><span class="line"></span>#mysql table rows</span><br><span class="line"><span class="header">mysql&gt; select * from users;</span><br><span class="line">+----+------+----------+----------+</span></span><br><span class="line"><span class="header">| id | name | fullname | password |</span><br><span class="line">+----+------+----------+----------+</span></span><br><span class="line">|  1 | ed   | ED Jones | 123456   |</span><br><span class="line">|  2 | san  | zhangsan | passsan  |</span><br><span class="line">|  3 | si   | zhangsi  | passsi   |</span><br><span class="line"><span class="header">|  4 | wu   | zhangwu  | passwu   |</span><br><span class="line">+----+------+----------+----------+</span></span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Rollback<br>Before session commit executing, we could use <strong>session.rollback()</strong> look up for changed data.</p>
</li>
<li><p>Deleting<br>Let’s try to delete ‘zhangsan’. Using <strong>sessiono.delete(object)</strong>.</p>
</li>
<li><p>Quering<br>Example</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="keyword">query</span> = session.<span class="keyword">query</span>(User).filter(User.name.liek("%<span class="keyword">ed</span>')).order_by(User.id)</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">query</span>.all() <span class="comment">//query.first()</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="0x04_The_end"><a href="#0x04_The_end" class="headerlink" title="0x04 The end"></a>0x04 The end</h1><p>More high-level usage refers to <a href="http://docs.sqlalchemy.org/en/rel_1_0/orm/tutorial.html" target="_blank" rel="external">Document of SQLAlchemy</a></p>
</div><div class="tags"><a href="/tags/db/">db</a><a href="/tags/python/">python</a></div><div class="post-nav"><a href="/2016/02/25/First-use-Flask/" class="pre"><i class="icon-previous">First use Flask</i></a><a href="/2016/02/18/Simple-Celery/" class="next">Simple Celery<i class="icon-next"></i></a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><div class="widget-title">分類</div></div><div class="widget"><div class="widget-title">標籤</div><div class="tagcloud"><a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/distribute/" style="font-size: 15px;">distribute</a> <a href="/tags/db/" style="font-size: 15px;">db</a> <a href="/tags/write/" style="font-size: 15px;">write</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/02/25/First-use-Flask/">First use Flask</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/21/SQLAlchemy/">SQLAlchemy</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/18/Simple-Celery/">Simple Celery</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/16/Redis-Docs/">Redis Doc</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/17/Hexo-Blog-Construct/">Hexo Blog Construct</a></li></ul></div><div class="widget"><div class="widget-title">友站連結</div></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">Sumarry and Promotion.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script><script src="/js/fancybox.pack.js" type="text/javascript"></script>
<script src="/js/jquery.fancybox.js" type="text/javascript"></script><link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css"></div></body></html>